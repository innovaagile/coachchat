<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CoachChat</title>
  <style>
    :root { --green:#7cc33f; --text:#1b1b1b; --bg:#f6f7f9; }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text);}
    .hero{ background:var(--green); color:#0a0a0a; padding:28px 20px; text-align:left;}
    .hero h1{ margin:0 0 6px; font-size:28px; font-weight:800;}
    .hero p{ margin:0; font-size:15px; opacity:.9;}
    .wrap{ max-width:920px; margin:22px auto; padding:0 16px; display:flex; justify-content:center; }
    .btn{
      display:inline-flex; gap:10px; align-items:center; justify-content:center;
      padding:14px 22px; font-size:18px; border-radius:12px; border:0;
      background:#111; color:#fff; cursor:pointer; box-shadow:0 6px 20px rgba(0,0,0,.15);
      transition:transform .05s ease-in-out, box-shadow .2s;
    }
    .btn:hover{ transform:translateY(-1px); box-shadow:0 10px 24px rgba(0,0,0,.18);}
    .btn:active{ transform:translateY(0); }
    #reply{max-width:720px; margin:18px auto 0; padding:12px 16px; color:#333}
  </style>
</head>
  <script>
  // Prueba simple: envía un POST controlado al endpoint serverless
  (function () {
    const btn = document.getElementById('coachBtn');
    if (!btn) { console.error('No existe #coachBtn'); return; }

    btn.addEventListener('click', async (ev) => {
      ev.preventDefault(); // por si el botón está dentro de un form

      try {
        const res = await fetch("/.netlify/functions/coachchat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: "Ping de prueba desde UI" })
        });

        const text = await res.text();
        console.log("HTTP", res.status, text);
        alert("HTTP " + res.status);   // Muestra 200, 400, 500, etc.
      } catch (e) {
        console.error("Fallo de red o CORS", e);
        alert("Error de red");
      }
    });
  })();
</script>

<body>
  <style>
    :root{
      --bg:#f3f4f6;          /* gris claro */
      --card:#ffffff;        /* blanco tarjeta */
      --border:#e5e7eb;      /* gris borde */
      --muted:#6b7280;       /* gris texto secundario */
      --text:#111827;        /* gris oscuro */
      --primary:#111827;     /* botón suave (como screenshot) */
      --primary-hover:#0b1220;
      --chip:#f9fafb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .card-body{padding:20px}
    .toolbar{display:flex;justify-content:flex-start;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border)}
    .btn{
      appearance:none;border:1px solid var(--border);background:#fff;color:var(--primary);
      padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;
    }
    .btn:hover{border-color:#d1d5db;background:#fbfbfb}
    .btn-primary{
      background:#fff;color:var(--primary);border:1px solid var(--border)
    }
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    #chat{display:flex;flex-direction:column;gap:10px;max-height:56vh;overflow:auto;padding:8px;border:1px dashed var(--border);border-radius:10px;background:#fff}
    .row{display:flex}
    .mine{justify-content:flex-end}
    .bubble{
      max-width:78%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);white-space:pre-wrap;line-height:1.35;font-size:14px;background:var(--chip)
    }
    .mine .bubble{background:#eef2ff;border-color:#dbeafe}
    .inputbar{display:flex;gap:10px;align-items:flex-start}
    textarea{flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:10px;resize:vertical;min-height:44px;background:#fff}
    .status{font-size:12px;color:var(--muted);margin-top:6px}
    /* Estado vacío */
    .empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 12px;gap:10px}
    .empty h3{margin:0;font-size:18px;color:#374151}
    .empty p{margin:0;color:var(--muted)}
    .icon{width:44px;height:44px;opacity:.8}
  </style>

  <div class="wrap">
    <div class="card">
      <div class="toolbar">
        <button class="btn btn-primary" id="newChat">+ Nueva conversación</button>
      </div>

      <div class="card-body">
        <div id="emptyState" class="empty" style="display:none">
          <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M6 16a6 6 0 1 1 9.33-7.5A4.5 4.5 0 1 1 18 16H6Z" stroke="#9ca3af" stroke-width="1.5"/></svg>
          <h3>No hay mensajes</h3>
          <p>Escribe abajo y presiona Enviar</p>
          <button class="btn" id="ctaStart">Escribir un mensaje</button>
        </div>

        <div class="grid">
          <div id="chat"></div>
          <div class="inputbar">
            <textarea id="coachMsg" placeholder="Escribe aquí…"></textarea>
            <button id="coachBtn" class="btn">Enviar</button>
          </div>
          <div id="coachStatus" class="status"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const chat = document.getElementById('chat');
      const field = document.getElementById('coachMsg');
      const btn = document.getElementById('coachBtn');
      const status = document.getElementById('coachStatus');
      const empty = document.getElementById('emptyState');
      const newChat = document.getElementById('newChat');
      const ctaStart = document.getElementById('ctaStart');

      let threadId = sessionStorage.getItem('coach_thread_id') || null;

      function toggleEmpty(){
        empty.style.display = chat.children.length ? 'none' : 'flex';
      }

      function addMsg(author, text){
        const row = document.createElement('div');
        row.className = 'row' + (author==='tú' ? ' mine' : '');
        const b = document.createElement('div');
        b.className = 'bubble';
        b.textContent = text;
        row.appendChild(b);
        chat.appendChild(row);
        chat.scrollTop = chat.scrollHeight;
        toggleEmpty();
      }

      async function enviar(message){
        status.textContent = 'Enviando…';
        btn.disabled = true;

        try{
          const res = await fetch('/.netlify/functions/coachchat', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ message, threadId })
          });
          const data = await res.json().catch(()=>null);

          if (!res.ok){
            const fallback = (data && (data.error || data.detail?.message)) || ('HTTP '+res.status);
            addMsg('coach','Error: '+fallback);
            status.textContent = '';
            btn.disabled = false;
            return;
          }

          if (data.threadId && data.threadId !== threadId){
            threadId = data.threadId;
            sessionStorage.setItem('coach_thread_id', threadId);
          }

          const reply = data && data.reply ? data.reply : '(sin respuesta)';
          addMsg('coach', reply);
          status.textContent = 'Listo';
        }catch(e){
          addMsg('coach','Error de red');
          status.textContent = '';
        }finally{
          btn.disabled = false;
        }
      }

      btn.addEventListener('click', ()=>{
        const m = (field.value || '').trim();
        if (!m){ field.focus(); return; }
        addMsg('tú', m);
        field.value = '';
        enviar(m);
      });

      field.addEventListener('keydown', (e)=>{
        if (e.key==='Enter' && !e.shiftKey){
          e.preventDefault();
          btn.click();
        }
      });

      newChat.addEventListener('click', ()=>{
        chat.innerHTML = '';
        sessionStorage.removeItem('coach_thread_id');
        threadId = null;
        toggleEmpty();
        field.focus();
      });
      ctaStart.addEventListener('click', ()=> field.focus());

      toggleEmpty();
    })();
  </script>
</body>
</html>


